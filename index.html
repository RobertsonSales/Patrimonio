<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Patrim√¥nio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <style>
        /* [ESTILOS ORIGINAIS MANTIDOS - SEM ALTERA√á√ïES] */
        body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        .container{background:rgba(255,255,255,.95);border-radius:15px;padding:30px;box-shadow:0 10px 30px rgba(0,0,0,.2)}
        h1{color:#2c3e50;text-align:center;margin-bottom:30px;font-weight:700;text-shadow:2px 2px 4px rgba(0,0,0,.1)}
        .card{margin-bottom:20px;border:none;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.1);transition:transform .3s ease,box-shadow .3s ease;background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);flex:1 1 calc(33.333% - 20px);min-width:300px}
        .card:hover{transform:translateY(-5px);box-shadow:0 8px 25px rgba(0,0,0,.15)}
        .card-title{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:15px;margin:-1rem -1rem 1rem -1rem;border-radius:12px 12px 0 0;font-weight:600;font-size:1.1rem}
        .card-body{padding:1.5rem}
        .no-results{color:#e74c3c;text-align:center;font-size:1.1rem;font-weight:500}
        #preview-modal .modal-body{height:80vh;overflow:auto}
        .card-container{display:flex;flex-wrap:wrap;gap:20px;justify-content:flex-start}
        .form-label{font-weight:600;color:#2c3e50;margin-bottom:8px}
        .form-control,.form-select{border:2px solid #e9ecef;border-radius:8px;padding:10px;transition:border-color .3s ease}
        .form-control:focus,.form-select:focus{border-color:#3498db;box-shadow:0 0 0 .2rem rgba(52,152,219,.25)}
        .btn{border-radius:8px;padding:10px 20px;font-weight:600;transition:all .3s ease;border:none}
        .btn-primary{background:linear-gradient(135deg,#3498db,#2980b9)}
        .btn-primary:hover{background:linear-gradient(135deg,#2980b9,#1f618d);transform:translateY(-2px);box-shadow:0 4px 15px rgba(52,152,219,.4)}
        .btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d)}
        .btn-secondary:hover{background:linear-gradient(135deg,#7f8c8d,#6c7b7d);transform:translateY(-2px)}
        .btn-success{background:linear-gradient(135deg,#27ae60,#219653)}
        .btn-success:hover{background:linear-gradient(135deg,#219653,#1e8449);transform:translateY(-2px)}
        .section-title{color:#2c3e50;border-bottom:2px solid #3498db;padding-bottom:10px;margin-bottom:20px;font-weight:600}
        .form-check-input:checked{background-color:#3498db;border-color:#3498db}
        .modal-header{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;border-radius:15px 15px 0 0}
        .search-container{position:relative}
        .client-list-container{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #dee2e6;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,.1);z-index:1000;max-height:300px;overflow-y:auto;display:none}
        .client-list-item{padding:10px 15px;border-bottom:1px solid #eee;cursor:pointer;transition:background-color .2s ease}
        .client-list-item:hover{background-color:#f8f9fa}
        .selected-clients-badge{background:#3498db;color:#fff;padding:4px 8px;border-radius:12px;font-size:.8rem;margin-right:5px;margin-bottom:5px;display:inline-block}
        .search-type-selector{background:#e9ecef;padding:15px;border-radius:8px;margin-bottom:15px}
        .search-type-buttons{display:flex;gap:15px;flex-wrap:wrap}
        .search-type-btn{flex:1;min-width:150px}
        .equipment-count{background:#27ae60;color:#fff;padding:5px 10px;border-radius:15px;font-size:.8rem;font-weight:bold;display:inline-block;margin-bottom:10px}
        .horizontal-equipment-container{display:flex;flex-wrap:wrap;gap:15px;margin-top:15px}
        .horizontal-equipment-item{flex:1 1 calc(33.333% - 15px);min-width:250px;background:#fff;padding:15px;border-radius:8px;border-left:4px solid #3498db;box-shadow:0 2px 8px rgba(0,0,0,.1);transition:transform .2s ease,box-shadow .2s ease}
        .horizontal-equipment-item:hover{transform:translateY(-3px);box-shadow:0 4px 12px rgba(0,0,0,.15)}
        .horizontal-equipment-item .equipment-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;border-bottom:1px solid #e9ecef;padding-bottom:8px}
        .horizontal-equipment-item .equipment-name{font-weight:600;color:#2c3e50;font-size:.9rem;margin:0;flex:1}
        .horizontal-equipment-item .unidade-badge{background:#e74c3c;color:#fff;padding:2px 6px;border-radius:10px;font-size:.7rem;font-weight:bold;margin-left:8px;white-space:nowrap}
        .horizontal-equipment-item .equipment-details{display:grid;grid-template-columns:1fr;gap:4px}
        .horizontal-equipment-item .detail-row{display:flex;justify-content:space-between}
        .horizontal-equipment-item .detail-label{font-weight:500;color:#495057;font-size:.75rem}
        .horizontal-equipment-item .detail-value{color:#2c3e50;font-size:.75rem;text-align:right}
        .filter-checkbox-group{background:#fff;border:1px solid #dee2e6;border-radius:8px;max-height:200px;overflow-y:auto;padding:10px;margin-top:5px}
        .filter-checkbox-item{padding:5px 0;border-bottom:1px solid #f8f9fa}
        .filter-checkbox-item:last-child{border-bottom:none}
        .filter-checkbox-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
        .select-all-btn{font-size:.8rem;padding:2px 8px}
        .filters-container{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;border-left:4px solid #f39c12}
        .filters-container .section-title{color:#2c3e50;border-bottom:2px solid #f39c12;padding-bottom:10px;margin-bottom:20px;font-weight:600}
        .columns-container{background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;border-left:4px solid #9b59b6}
        .columns-container .section-title{color:#2c3e50;border-bottom:2px solid #9b59b6;padding-bottom:10px;margin-bottom:20px;font-weight:600}
        .category-summary-btn{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;border:none}
        .category-summary-btn:hover{background:linear-gradient(135deg,#8e44ad,#7d3c98);transform:translateY(-2px);box-shadow:0 4px 15px rgba(155,89,182,.4)}
        .filter-summary-card{background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%);border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.1);margin-bottom:20px;border-left:4px solid #27ae60}
        .filter-summary-header{background:linear-gradient(135deg,#27ae60,#219653);color:#fff;padding:15px;border-radius:12px 12px 0 0;font-weight:600;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center}
        .filter-summary-body{padding:1.5rem}
        .filter-summary-section{margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #e9ecef}
        .filter-summary-section:last-child{margin-bottom:0;padding-bottom:0;border-bottom:none}
        .filter-summary-title{font-weight:600;color:#2c3e50;margin-bottom:10px;font-size:1rem}
        .filter-summary-item{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #f8f9fa}
        .filter-summary-item:last-child{border-bottom:none}
        .filter-summary-label{font-weight:500;color:#495057}
        .filter-summary-count{background:#3498db;color:#fff;padding:2px 8px;border-radius:12px;font-size:.75rem;font-weight:bold}
        .filter-summary-equipment{background:#fff;padding:10px;border-radius:8px;margin-bottom:10px;border-left:3px solid #3498db}
        .filter-summary-equipment:last-child{margin-bottom:0}
        .filter-summary-equipment-name{font-weight:600;color:#2c3e50;margin-bottom:5px}
        .filter-summary-equipment-details{display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:.8rem}
        .filter-summary-equipment-detail{display:flex;justify-content:space-between}
        .filter-summary-equipment-label{font-weight:500;color:#495057}
        .filter-summary-equipment-value{color:#2c3e50}

        /* ESTILOS DE UPLOAD E MOBILE */
        .file-upload-container {
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border: 2px dashed #e74c3c;
            transition: all 0.3s ease;
        }
        .file-upload-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            border-color: #c0392b;
        }
        .file-upload-label {
            font-weight: 700;
            font-size: 1.2rem;
            color: #c0392b;
            margin-bottom: 10px;
            display: block;
        }
        .file-upload-icon {
            font-size: 2rem;
            margin-right: 10px;
            vertical-align: middle;
            color: #e74c3c;
        }
        .file-upload-input {
            border: 2px solid #e74c3c;
            border-radius: 8px;
            padding: 12px;
            background-color: rgba(255,255,255,0.9);
            transition: all 0.3s ease;
        }
        .file-upload-input:focus {
            border-color: #c0392b;
            box-shadow: 0 0 0 0.25rem rgba(231, 76, 60, 0.25);
        }
        .mobile-pdf-actions {
            display: none;
            margin-top: 15px;
            gap: 10px;
        }

        /* ESTILOS DO VISUALIZADOR DE PDF (CORRIGIDO PARA MOBILE) */
        #pdf-preview-body { background:#f8f9fa; position:relative; }
        #pdf-embed, #pdf-object { display:block; width:100%; height:100%; border:none; border-radius:8px; }
        #pdf-fallback-link { color:#3498db; text-decoration:underline; }

        /* NOVOS ESTILOS PARA RESUMOS EM TABELAS DIN√ÇMICAS */
        .summary-table-container {
            margin-top: 20px;
        }
        .summary-table-card {
            margin-bottom: 25px;
        }
        .summary-table {
            width: 100%;
            font-size: 0.85rem;
            border-collapse: collapse;
        }
        .summary-table th {
            background-color: #3498db;
            color: white;
            padding: 8px 10px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        .summary-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #e9ecef;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .summary-table tr:hover {
            background-color: #e9ecef;
        }
        .category-count-badge {
            background-color: #9b59b6;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        .category-column {
            text-align: center;
            font-weight: 600;
        }
        .total-row {
            background-color: #2c3e50 !important;
            color: white;
            font-weight: bold;
        }

        /* NOVO BOT√ÉO RESUMO DETALHADO */
        .detailed-summary-btn {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: #fff;
            border: none;
            margin-top: 10px;
        }
        .detailed-summary-btn:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Gerenciador de Patrim√¥nio</h1>

    <div class="file-upload-container">
        <span class="file-upload-icon">üìä</span>
        <label for="file-upload" class="file-upload-label">Importar Planilha (.xlsx)</label>
        <input type="file" id="file-upload" class="form-control file-upload-input" accept=".xlsx">
        <small class="text-muted mt-2 d-block">Selecione um arquivo Excel (.xlsx) para carregar os dados de patrim√¥nio</small>
    </div>

    <div class="filter-section">
        <h5 class="section-title">Pesquisar e Selecionar</h5>

        <div class="search-type-selector">
            <label class="form-label mb-3">Tipo de Pesquisa:</label>
            <div class="search-type-buttons">
                <div class="form-check search-type-btn">
                    <input class="form-check-input" type="radio" name="searchType" id="searchCliente" value="cliente" checked onchange="changeSearchType()">
                    <label class="form-check-label" for="searchCliente">Pesquisar por Cliente</label>
                </div>
                <div class="form-check search-type-btn">
                    <input class="form-check-input" type="radio" name="searchType" id="searchUnidade" value="unidade" onchange="changeSearchType()">
                    <label class="form-check-label" for="searchUnidade">Pesquisar por Unidade</label>
                </div>
                <div class="form-check search-type-btn">
                    <input class="form-check-input" type="radio" name="searchType" id="searchCategoria" value="categoria" onchange="changeSearchType()">
                    <label class="form-check-label" for="searchCategoria">Pesquisar por Categoria</label>
                </div>
            </div>
        </div>

        <div class="row g-3">
            <div class="col-md-6">
                <label for="search" class="form-label" id="search-label">Digite para buscar clientes:</label>
                <div class="search-container">
                    <input type="text" id="search" class="form-control" placeholder="Digite para buscar..." oninput="showSuggestions()" onfocus="showSuggestions()">
                    <div id="suggestions" class="client-list-container"></div>
                </div>
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-danger w-100" onclick="clearSearch()">Limpar Pesquisa</button>
            </div>

            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success w-100" onclick="toggleAllClients()" id="toggle-all-btn">
                    Selecionar/Desselecionar Todos os Clientes
                </button>
            </div>
        </div>

        <div class="mt-3">
            <label class="form-label" id="selected-label">Itens Selecionados:</label>
            <div id="selected-items-display" class="mb-3"><span class="text-muted">Nenhum item selecionado</span></div>
        </div>

        <div id="category-summary-btn-container" class="d-none mt-3">
            <button class="btn category-summary-btn w-100" onclick="showCategorySummaryModal()">Ver Resumo por Categoria</button>
        </div>
    </div>

    <div class="columns-container">
        <h5 class="section-title">Colunas a Exibir</h5>
        <div id="column-checkboxes" class="row"></div>
    </div>

    <div class="filters-container">
        <h5 class="section-title">Filtros de Exibi√ß√£o</h5>
        
        <div class="mb-3">
            <button class="btn detailed-summary-btn w-100" onclick="showDetailedSummaryModal()">
                Ver Resumo Detalhado por Cliente
            </button>
        </div>
        
        <div class="filters row g-3">
            <div class="col-md-4">
                <div class="filter-checkbox-header">
                    <label class="form-label">Regi√£o</label>
                    <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" onclick="selectAll('regiao')">Selecionar Todos</button>
                </div>
                <div id="filter-regiao-checkboxes" class="filter-checkbox-group"></div>
            </div>
            <div class="col-md-4">
                <div class="filter-checkbox-header">
                    <label class="form-label">Categoria</label>
                    <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" onclick="selectAll('categoria')">Selecionar Todos</button>
                </div>
                <div id="filter-categoria-checkboxes" class="filter-checkbox-group"></div>
            </div>
            <div class="col-md-4">
                <div class="filter-checkbox-header">
                    <label class="form-label">Equipamento</label>
                    <button type="button" class="btn btn-sm btn-outline-primary select-all-btn" onclick="selectAll('equipamento')">Selecionar Todos</button>
                </div>
                <div id="filter-equipamento-checkboxes" class="filter-checkbox-group"></div>
            </div>
        </div>
        <div class="mt-3 text-end">
            <button class="btn btn-secondary" onclick="clearAllFilters()" id="clear-all-filters-btn">Limpar Filtros</button>
        </div>
    </div>

    <div id="filter-summary-container" class="d-none">
        <div class="filter-summary-card">
            <div class="filter-summary-header">
                <span>Resumo dos Filtros Aplicados</span>
                <button class="btn btn-sm btn-light" onclick="previewFilterSummaryPDF()">Gerar PDF</button>
            </div>
            <div class="filter-summary-body">
                <div class="filter-summary-section"><div class="filter-summary-title">Filtros Ativos</div><div id="active-filters-list"></div></div>
                
                <div class="filter-summary-section">
                    <div class="filter-summary-title">Resumo por Cliente</div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm summary-table" id="client-summary-table">
                            <thead id="client-summary-header">
                                </thead>
                            <tbody id="client-summary-body">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="filter-summary-section">
                    <div class="filter-summary-title">Resumo por Unidade</div>
                    <div class="table-responsive">
                        <table class="table table-striped table-sm summary-table" id="unit-summary-table">
                            <thead id="unit-summary-header">
                                </thead>
                            <tbody id="unit-summary-body">
                                </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="filter-summary-section"><div class="filter-summary-title">Equipamentos Encontrados</div><div id="equipment-summary-list"></div></div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
        <button class="btn btn-success" onclick="exportToExcel()" disabled id="excel-btn">Exportar para Excel</button>
        <button class="btn btn-primary" onclick="previewPDF()" disabled id="pdf-btn">Visualizar/Imprimir PDF</button>
    </div>

    <div class="card-container" id="results"></div>
    <p id="no-results" class="no-results d-none">Nenhum equipamento encontrado para os itens selecionados.</p>
</div>

<div class="modal fade" id="preview-modal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Pr√©-visualiza√ß√£o do PDF</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pdf-preview-body" style="position:relative; height:80vh; padding:0;">
                <embed id="pdf-embed" type="application/pdf" width="100%" height="100%" style="border:none; border-radius:8px;">
                <object id="pdf-object" data="" type="application/pdf" width="100%" height="100%" style="border:none; border-radius:8px;">
                    <p>Seu navegador n√£o suporta visualiza√ß√£o de PDF. <a href="#" id="pdf-fallback-link">Baixar PDF</a></p>
                </object>
                <div class="mobile-pdf-actions">
                    <button type="button" class="btn btn-primary" onclick="downloadPDF()">Baixar PDF</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
            <div class="modal-footer d-none d-md-flex">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="downloadPDF()">Baixar PDF</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailed-summary-modal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resumo Detalhado por Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm summary-table" id="detailed-summary-table">
                        <thead id="detailed-summary-header">
                            </thead>
                        <tbody id="detailed-summary-body">
                            </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" onclick="generateDetailedSummaryPDF()">Gerar PDF</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const { jsPDF } = window.jspdf;
    let data = [], filteredData = [];
    const allFields = ['regiao','categoria','instalacao','unidade','equipamento','serial','cdPat','tec','cnpj','cliente','prevAtual','proxPrev','trocaLamp','trocaProb','trocaRefer','trocaLs','obs'];
    const fieldLabels = {regiao:'Regi√£o',categoria:'Categoria',instalacao:'Instala√ß√£o',unidade:'Unidade',equipamento:'Equipamento',serial:'Serial',cdPat:'CD PAT',tec:'Tec',cnpj:'CNPJ',cliente:'Cliente',prevAtual:'Prev. Atual',proxPrev:'Prox. Prev',trocaLamp:'Troca de L√¢mp',trocaProb:'Troca de Prob',trocaRefer:'Troca Refer',trocaLs:'Troca da LS',obs:'OBS'};
    let selectedFields = new Set(), selectedItems = new Set(), currentSearchType = 'cliente';
    let selectedRegioes = new Set(), selectedCategorias = new Set(), selectedEquipamentos = new Set();
    let isSearchMode = false;
    let currentPdfBlobUrl = null;

    /* ---------- FUN√á√ïES AUXILIARES E DE UTILIDADE ---------- */
    function formatExcelDate(v){if(!v)return'';if(typeof v!=='string'&&typeof v!=='number')return v;if(typeof v==='number'){const d=new Date((v-(25567+2))*86400*1000);return d.toLocaleDateString('pt-BR')}return v;}
    function groupBy(arr, key) { return arr.reduce((acc, obj) => { const k = obj[key] || `Sem ${key.charAt(0).toUpperCase() + key.slice(1)}`; (acc[k] = acc[k] || []).push(obj); return acc; }, {}); }
    function hideSuggestions() { document.getElementById('suggestions').style.display = 'none'; }
    function openPDFPreview(blob) {
        if (currentPdfBlobUrl) URL.revokeObjectURL(currentPdfBlobUrl);
        currentPdfBlobUrl = URL.createObjectURL(blob);
        document.getElementById('pdf-embed').src = currentPdfBlobUrl;
        document.getElementById('pdf-object').data = currentPdfBlobUrl;
        document.getElementById('pdf-fallback-link').href = currentPdfBlobUrl;
        new bootstrap.Modal(document.getElementById('preview-modal')).show();
    }
    function downloadPDF() {
        const a = document.createElement('a');
        a.href = currentPdfBlobUrl;
        a.download = 'Relatorio_Patrimonio.pdf';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }
    
    /* ---------- FUN√á√ïES DE MANIPULA√á√ÉO DE DADOS E FILTROS ---------- */
    function processExcelData(dataArray){
        data = dataArray.map(r => ({
            regiao: r[0], categoria: r[1],
            instalacao: formatExcelDate(r[2]), unidade: r[3],
            equipamento: r[4], serial: r[5], cdPat: r[6],
            tec: r[7], cnpj: r[8], cliente: r[9],
            prevAtual: formatExcelDate(r[10]), proxPrev: formatExcelDate(r[11]),
            trocaLamp: r[12], trocaProb: r[13], trocaRefer: r[14],
            trocaLs: r[15], obs: r[16]
        })).filter(i=>Object.values(i).some(v=>v!==''));
        populateFilters();
        populateSuggestions();
        document.getElementById('excel-btn').disabled = false;
        document.getElementById('pdf-btn').disabled = false;
        alert(`Planilha carregada com sucesso! N√∫mero de registros: ${data.length}`);
        applyFilters(); // Aplica filtros iniciais (todos)
    }
    
    document.getElementById('file-upload').addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            const data = event.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const firstSheet = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheet];
            // Converte para array de arrays (omitindo o cabe√ßalho)
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
            processExcelData(json.slice(1));
        };
        reader.readAsBinaryString(e.target.files[0]);
    });

    function populateColumnCheckboxes(){
        const container = document.getElementById('column-checkboxes');
        container.innerHTML = '';
        allFields.forEach((field, index) => {
            const div = document.createElement('div');
            div.className = 'col-md-4 form-check';
            div.innerHTML = `<input class="form-check-input" type="checkbox" value="${field}" id="col-${field}" onchange="updateSelectedFields()" ${['cliente','unidade','equipamento','serial','prevAtual','proxPrev'].includes(field) ? 'checked' : ''}> <label class="form-check-label" for="col-${field}">${fieldLabels[field]}</label>`;
            container.appendChild(div);
            if (['cliente','unidade','equipamento','serial','prevAtual','proxPrev'].includes(field)) selectedFields.add(field);
        });
        updateSelectedFields();
    }
    populateColumnCheckboxes();

    function updateSelectedFields(){
        selectedFields.clear();
        document.querySelectorAll('#column-checkboxes .form-check-input:checked').forEach(cb => selectedFields.add(cb.value));
        applyFilters();
    }

    function populateFilters(){
        const filters = {
            regiao: new Set(data.map(i => i.regiao).filter(v => v)),
            categoria: new Set(data.map(i => i.categoria).filter(v => v)),
            equipamento: new Set(data.map(i => i.equipamento).filter(v => v))
        };
        Object.keys(filters).forEach(key => {
            const container = document.getElementById(`filter-${key}-checkboxes`);
            container.innerHTML = '';
            Array.from(filters[key]).sort().forEach(value => {
                const div = document.createElement('div');
                div.className = 'filter-checkbox-item form-check';
                div.innerHTML = `<input class="form-check-input" type="checkbox" value="${value}" id="filter-${key}-${value}" onchange="updateFilter('${key}', this)"> <label class="form-check-label" for="filter-${key}-${value}">${value}</label>`;
                container.appendChild(div);
            });
        });
    }

    function updateFilter(type, checkbox){
        const set = type === 'regiao' ? selectedRegioes : type === 'categoria' ? selectedCategorias : selectedEquipamentos;
        if (checkbox.checked) set.add(checkbox.value);
        else set.delete(checkbox.value);
        applyFilters();
    }

    function selectAll(type){
        const checkboxes = document.querySelectorAll(`#filter-${type}-checkboxes .form-check-input`);
        const set = type === 'regiao' ? selectedRegioes : type === 'categoria' ? selectedCategorias : selectedEquipamentos;
        
        // Verifica se todos est√£o selecionados para poder desmarcar
        const allChecked = Array.from(checkboxes).every(cb => cb.checked);
        
        checkboxes.forEach(cb => {
            cb.checked = !allChecked;
            if (cb.checked) set.add(cb.value);
            else set.delete(cb.value);
        });
        applyFilters();
    }

    function clearSearch(){
        document.getElementById('search').value = '';
        hideSuggestions();
        selectedItems.clear();
        updateSelectedDisplay();
        applyFilters();
    }

    // Fun√ß√£o de Limpar Filtros CORRIGIDA para limpar tamb√©m a pesquisa
    function clearAllFilters(){
        // Limpa os filtros de Regi√£o, Categoria, Equipamento
        ['regiao', 'categoria', 'equipamento'].forEach(type => {
            document.querySelectorAll(`#filter-${type}-checkboxes .form-check-input`).forEach(cb => {
                cb.checked = false;
            });
            if (type === 'regiao') selectedRegioes.clear();
            else if (type === 'categoria') selectedCategorias.clear();
            else selectedEquipamentos.clear();
        });

        // Limpa o campo de Pesquisa e a sele√ß√£o de itens (Corrigido)
        document.getElementById('search').value = '';
        hideSuggestions();
        selectedItems.clear();

        // Atualiza a exibi√ß√£o e aplica os filtros
        updateSelectedDisplay();
        applyFilters();
    }

    function applyFilters(){
        filteredData = data.filter(i => {
            const matchesSearch = selectedItems.size === 0 || selectedItems.has(i[currentSearchType]);
            const matchesRegiao = selectedRegioes.size === 0 || selectedRegioes.has(i.regiao);
            const matchesCategoria = selectedCategorias.size === 0 || selectedCategorias.has(i.categoria);
            const matchesEquipamento = selectedEquipamentos.size === 0 || selectedEquipamentos.has(i.equipamento);
            return matchesSearch && matchesRegiao && matchesCategoria && matchesEquipamento;
        });
        renderResults();
        updateFilterSummary();
    }

    function renderResults(){
        const resultsDiv = document.getElementById('results');
        const noResults = document.getElementById('no-results');

        if (filteredData.length === 0){
            resultsDiv.innerHTML = '';
            noResults.classList.remove('d-none');
            return;
        }

        noResults.classList.add('d-none');
        
        const grouped = groupBy(filteredData, 'unidade');

        resultsDiv.innerHTML = Object.keys(grouped).sort().map(unidade => {
            const items = grouped[unidade];
            const equipmentList = items.map(item => {
                const details = Array.from(selectedFields).map(field => {
                    if (field !== 'unidade') {
                        const value = item[field] || 'N/A';
                        return `<div class="detail-row"><span class="detail-label">${fieldLabels[field]}:</span> <span class="detail-value">${value}</span></div>`;
                    }
                    return '';
                }).join('');

                return `
                    <div class="horizontal-equipment-item">
                        <div class="equipment-header">
                            <p class="equipment-name">${item.equipamento || 'Sem Equipamento'}</p>
                            <span class="unidade-badge">${item.regiao || 'N/A'}</span>
                        </div>
                        <div class="equipment-details">
                            ${details}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="card w-100 summary-table-card">
                    <div class="card-title">${unidade} <span class="equipment-count">${items.length} Equipamentos</span></div>
                    <div class="card-body">
                        <div class="horizontal-equipment-container">
                            ${equipmentList}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    function populateSuggestions(){
        const searchInput = document.getElementById('search');
        const searchKey = currentSearchType;
        const searchValues = Array.from(new Set(data.map(item => item[searchKey]).filter(v => v))).sort();
        searchInput.setAttribute('data-suggestions', JSON.stringify(searchValues));
        searchInput.placeholder = `Digite para buscar ${searchKey}s...`;
    }

    function showSuggestions(){
        const searchInput = document.getElementById('search');
        const suggestionsDiv = document.getElementById('suggestions');
        const searchTerm = searchInput.value.toLowerCase();
        const searchKey = currentSearchType;
        const allSuggestions = JSON.parse(searchInput.getAttribute('data-suggestions') || '[]');
        
        const filteredSuggestions = allSuggestions
            .filter(s => s.toLowerCase().includes(searchTerm))
            .slice(0, 20); // Limita a 20 sugest√µes

        suggestionsDiv.innerHTML = '';
        if (searchTerm.length > 0 && filteredSuggestions.length > 0) {
            filteredSuggestions.forEach(suggestion => {
                const item = document.createElement('div');
                item.className = 'client-list-item';
                item.textContent = suggestion;
                item.onclick = () => { toggleItem(suggestion); hideSuggestions(); searchInput.value = ''; };
                suggestionsDiv.appendChild(item);
            });
            suggestionsDiv.style.display = 'block';
        } else {
            suggestionsDiv.style.display = 'none';
        }
    }

    function toggleItem(item){
        if (selectedItems.has(item)) selectedItems.delete(item);
        else selectedItems.add(item);
        updateSelectedDisplay();
        applyFilters();
    }

    function updateSelectedDisplay(){
        const display = document.getElementById('selected-items-display');
        display.innerHTML = selectedItems.size === 0 ? '<span class="text-muted">Nenhum item selecionado</span>' : Array.from(selectedItems).map(i => `<span class="selected-clients-badge">${i} <button type="button" class="btn-close btn-close-white" style="font-size:0.6rem" onclick="toggleItem('${i}')"></button></span>`).join('');
    }

    function changeSearchType(){
        currentSearchType = document.querySelector('input[name="searchType"]:checked').value;
        const label = document.getElementById('search-label');
        const selectedLabel = document.getElementById('selected-label');
        const toggleBtn = document.getElementById('toggle-all-btn');

        label.textContent = `Digite para buscar ${currentSearchType}s:`;
        selectedLabel.textContent = `${currentSearchType.charAt(0).toUpperCase() + currentSearchType.slice(1)}s Selecionados:`;
        toggleBtn.textContent = `Selecionar/Desselecionar Todos os ${currentSearchType.charAt(0).toUpperCase() + currentSearchType.slice(1)}s`;

        document.getElementById('search').value = '';
        selectedItems.clear();
        populateSuggestions();
        updateSelectedDisplay();
        applyFilters();
    }

    function toggleAllClients(){
        const searchKey = currentSearchType;
        const allValues = Array.from(new Set(data.map(item => item[searchKey]).filter(v => v)));

        if (selectedItems.size > 0 && selectedItems.size === allValues.length) {
            selectedItems.clear();
        } else {
            selectedItems = new Set(allValues);
        }
        updateSelectedDisplay();
        applyFilters();
    }

    function updateFilterSummary(){
        const c = document.getElementById('filter-summary-container');
        if (filteredData.length === 0){
            c.classList.add('d-none');
            return;
        }
        c.classList.remove('d-none');

        // 1. Filtros Ativos (Lista Textual)
        const a = document.getElementById('active-filters-list');
        a.innerHTML='';
        const activeFilters = [];
        if(selectedItems.size>0) activeFilters.push(`${currentSearchType.charAt(0).toUpperCase()+currentSearchType.slice(1)}: ${[...selectedItems].join(', ')}`);
        if(selectedRegioes.size>0) activeFilters.push(`Regi√µes: ${[...selectedRegioes].join(', ')}`);
        if(selectedCategorias.size>0) activeFilters.push(`Categorias: ${[...selectedCategorias].join(', ')}`);
        if(selectedEquipamentos.size>0) activeFilters.push(`Equipamentos: ${[...selectedEquipamentos].join(', ')}`);
        a.innerHTML = activeFilters.map(f=>`<div class="filter-summary-item"><div class="filter-summary-label">${f}</div></div>`).join('');

        // 2. Resumo por Cliente
        const clientSummary = {};
        const allCategories = new Set();
        filteredData.forEach(i => {
            const client = i.cliente || 'Sem Cliente';
            const category = i.categoria || 'Sem Categoria';
            if (!clientSummary[client]) {
                clientSummary[client] = { unidades: new Set(), categorias: {}, totalEquipamentos: 0 };
            }
            clientSummary[client].unidades.add(i.unidade);
            clientSummary[client].categorias[category] = (clientSummary[client].categorias[category] || 0) + 1;
            clientSummary[client].totalEquipamentos++;
            allCategories.add(category);
        });

        const clientHeader = document.getElementById('client-summary-header');
        clientHeader.innerHTML = '';
        let headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>Cliente</th><th>Unidades</th><th>Total</th>';
        Array.from(allCategories).sort().forEach(cat => { headerRow.innerHTML += `<th>${cat}</th>`; });
        clientHeader.appendChild(headerRow);

        const clientBody = document.getElementById('client-summary-body');
        clientBody.innerHTML = '';
        Object.keys(clientSummary).sort().forEach(client => {
            const row = document.createElement('tr');
            let rowHTML = `<td>${client}</td><td>${clientSummary[client].unidades.size}</td><td class="category-column"><strong>${clientSummary[client].totalEquipamentos}</strong></td>`;
            Array.from(allCategories).sort().forEach(cat => {
                const count = clientSummary[client].categorias[cat] || 0;
                rowHTML += `<td class="category-column">${count > 0 ? count : '-'}</td>`;
            });
            row.innerHTML = rowHTML;
            clientBody.appendChild(row);
        });

        // Linha de Total Cliente
        const totalRowClient = document.createElement('tr');
        totalRowClient.className = 'total-row';
        let totalHTMLClient = `<td><strong>TOTAL</strong></td><td><strong>${new Set(filteredData.map(i => i.unidade)).size}</strong></td><td class="category-column"><strong>${filteredData.length}</strong></td>`;
        Array.from(allCategories).sort().forEach(cat => {
            const count = filteredData.filter(i => i.categoria === cat).length;
            totalHTMLClient += `<td class="category-column">${count}</td>`;
        });
        totalRowClient.innerHTML = totalHTMLClient;
        clientBody.appendChild(totalRowClient);

        // 3. Resumo por Unidade
        const unitSummary = {};
        filteredData.forEach(i => {
            const unit = i.unidade || 'Sem Unidade';
            const category = i.categoria || 'Sem Categoria';
            if (!unitSummary[unit]) {
                unitSummary[unit] = { cliente: i.cliente || 'Sem Cliente', categorias: {}, totalEquipamentos: 0 };
            }
            unitSummary[unit].categorias[category] = (unitSummary[unit].categorias[category] || 0) + 1;
            unitSummary[unit].totalEquipamentos++;
        });

        const unitHeader = document.getElementById('unit-summary-header');
        unitHeader.innerHTML = '';
        let headerRowUnit = document.createElement('tr');
        headerRowUnit.innerHTML = '<th>Unidade</th><th>Cliente</th><th>Total</th>';
        Array.from(allCategories).sort().forEach(cat => { headerRowUnit.innerHTML += `<th>${cat}</th>`; });
        unitHeader.appendChild(headerRowUnit);

        const unitBody = document.getElementById('unit-summary-body');
        unitBody.innerHTML = '';
        Object.keys(unitSummary).sort().forEach(unit => {
            const row = document.createElement('tr');
            let rowHTML = `<td>${unit}</td><td>${unitSummary[unit].cliente}</td><td class="category-column"><strong>${unitSummary[unit].totalEquipamentos}</strong></td>`;
            Array.from(allCategories).sort().forEach(cat => {
                const count = unitSummary[unit].categorias[cat] || 0;
                rowHTML += `<td class="category-column">${count > 0 ? count : '-'}</td>`;
            });
            row.innerHTML = rowHTML;
            unitBody.appendChild(row);
        });

        // Linha de Total Unidade
        const totalRowUnit = document.createElement('tr');
        totalRowUnit.className = 'total-row';
        let totalHTMLUnit = `<td><strong>TOTAL</strong></td><td>-</td><td class="category-column"><strong>${filteredData.length}</strong></td>`;
        Array.from(allCategories).sort().forEach(cat => {
            const count = filteredData.filter(i => i.categoria === cat).length;
            totalHTMLUnit += `<td class="category-column">${count}</td>`;
        });
        totalRowUnit.innerHTML = totalHTMLUnit;
        unitBody.appendChild(totalRowUnit);


        // 4. Equipamentos Encontrados
        const e = document.getElementById('equipment-summary-list');
        e.innerHTML = '';
        const equipCount = {};
        filteredData.forEach(i => { equipCount[i.equipamento || 'Sem Equipamento'] = (equipCount[i.equipamento || 'Sem Equipamento'] || 0) + 1; });
        Object.keys(equipCount).sort().forEach(eq=>{
            const d = document.createElement('div');
            d.className='filter-summary-equipment';
            d.innerHTML = `<div class="filter-summary-equipment-name">${eq}</div> <div class="filter-summary-equipment-details"> <div class="filter-summary-equipment-detail"><div class="filter-summary-equipment-label">Quantidade:</div><div class="filter-summary-equipment-value">${equipCount[eq]}</div></div> </div>`;
            e.appendChild(d);
        });
    }

    /* ---------- EXPORTAR PARA EXCEL ---------- */
    function exportToExcel(){
        if (filteredData.length === 0) {
            alert('Nenhum dado para exportar.');
            return;
        }

        const fields = Array.from(selectedFields);
        const headers = fields.map(f => fieldLabels[f]);
        const dataForExport = filteredData.map(item => fields.map(field => item[field]));
        
        const worksheet = XLSX.utils.aoa_to_sheet([headers, ...dataForExport]);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Patrimonio Filtrado");
        XLSX.writeFile(workbook, "Patrimonio_Filtrado.xlsx");
    }

    /* ---------- FUN√á√ïES AUXILIARES DE PDF (Recupera√ß√£o de Estrutura) ---------- */
    
    // Simples fun√ß√£o de agrupamento para uso interno do PDF
    function groupByPdf(arr, key) { return arr.reduce((acc, obj) => { const k = obj[key] || `Sem ${key.charAt(0).toUpperCase() + key.slice(1)}`; (acc[k] = acc[k] || []).push(obj); return acc; }, {}); }

    // Adiciona Cabe√ßalho e Rodap√© a cada p√°gina do PDF
    function addHeaderFooter(doc, title) {
        doc.autoTable({
            startY: 10,
            head: [[`Relat√≥rio de Patrim√¥nio - ${title}`]],
            theme: 'plain',
            styles: {
                fontSize: 12,
                fontStyle: 'bold',
                halign: 'center',
                textColor: [41, 128, 185]
            },
            body: [],
            didDrawPage: (data) => {
                doc.setFontSize(8);
                doc.setTextColor(150);
                doc.text(`P√°gina ${data.pageNumber} de ${doc.internal.pages.length - 1}`, data.settings.margin.left, doc.internal.pageSize.height - 10);
                doc.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
                // Reinicia startY para a primeira p√°gina ap√≥s o cabe√ßalho
                if (data.pageNumber > 1) {
                    doc.setFontSize(12);
                    doc.setTextColor(41, 128, 185);
                    doc.text(title, data.settings.margin.left, 15);
                }
            }
        });
    }

    // Adiciona Resumo Textual dos Filtros
    function addFilterSummary(doc, startY) {
        const pageBottomMargin = 15;
        const activeFilters = [];
        if(selectedItems.size>0) activeFilters.push(`${currentSearchType.charAt(0).toUpperCase()+currentSearchType.slice(1)}: ${[...selectedItems].join(', ')}`);
        if(selectedRegioes.size>0) activeFilters.push(`Regi√µes: ${[...selectedRegioes].join(', ')}`);
        if(selectedCategorias.size>0) activeFilters.push(`Categorias: ${[...selectedCategorias].join(', ')}`);
        if(selectedEquipamentos.size>0) activeFilters.push(`Equipamentos: ${[...selectedEquipamentos].join(', ')}`);

        if (activeFilters.length > 0) {
            const filterRows = activeFilters.map(f => [f]);

            if (startY > doc.internal.pageSize.height - pageBottomMargin - 50) {
                doc.addPage();
                startY = 18;
            }

            doc.setFontSize(11);
            doc.setTextColor(41,128,185);
            doc.setFont(undefined, 'bold');
            doc.text('Filtros Aplicados:', 14, startY);
            doc.setFont(undefined, 'normal');
            startY += 3;

            doc.autoTable({
                body: filterRows,
                startY: startY,
                theme: 'plain',
                styles: { fontSize: 8, cellPadding: 1 },
                margin: { left: 14, right: 14, bottom: pageBottomMargin }
            });
            startY = doc.lastAutoTable.finalY + 8;
        }

        return startY;
    }

    // Adiciona Resumo por Categoria e Regi√£o (CARDS) - FUN√á√ÉO CORRIGIDA
    function addRegiaoCategoriaSummaryCards(doc, startY){
        const sum = {}; let grandTotal = 0;
        filteredData.forEach(i=>{
            const c = i.categoria || 'Sem Categoria';
            const r = i.regiao || 'Sem Regi√£o';
            if(!sum[c]) sum[c] = {total:0};
            if(!sum[c][r]) sum[c][r] = 0;
            sum[c][r]++; sum[c].total++; grandTotal++;
        });

        const pageBottomMargin = 15;
        const categories = Object.keys(sum).sort();
        const cardsPerRow = 6;
        let col = 0, rowY = startY;
        const cardWidth = 40;
        const cardHeight = 48; 
        const cardGap = 4;
        const maxRegionsToShow = 10; // Limita o n√∫mero de regi√µes para evitar estouro

        // Verifica se h√° espa√ßo suficiente para o t√≠tulo
        if (startY > doc.internal.pageSize.height - pageBottomMargin - 50) {
            doc.addPage();
            rowY = 18;
        }

        doc.setFontSize(11); 
        doc.setTextColor(41,128,185);
        doc.setFont(undefined, 'bold');
        doc.text('Resumo por Categoria e Regi√£o:', 14, rowY);
        doc.setFont(undefined, 'normal');
        rowY += 5;

        categories.forEach((cat, idx) => {
            if (selectedCategorias.size === 0 || selectedCategorias.has(cat)) {
                
                // Quebra de p√°gina para o pr√≥ximo card, se necess√°rio
                if (col === 0 && rowY + cardHeight > doc.internal.pageSize.height - pageBottomMargin) {
                    doc.addPage();
                    rowY = 18;
                }

                const regions = Object.keys(sum[cat]).filter(r => r !== 'total').sort();
                const totalCat = sum[cat].total;
                const cardX = 14 + col * (cardWidth + cardGap);
                
                doc.setDrawColor(200,200,200);
                doc.setFillColor(245,245,245);
                doc.rect(cardX, rowY, cardWidth, cardHeight, 'FD'); // Fundo

                // Cabe√ßalho (Fixo)
                doc.setFillColor(41,128,185);
                doc.rect(cardX, rowY, cardWidth, 5, 'F'); 
                doc.setTextColor(255,255,255);
                doc.setFontSize(7.5); 
                doc.text(cat.substring(0, cardWidth/2), cardX + 2, rowY + 3.5); 

                // Detalhes das Regi√µes (√Årea de Scroll/Detalhes)
                doc.setTextColor(0,0,0);
                doc.setFontSize(6.5);
                let y = rowY + 8;
                
                // Limita a exibi√ß√£o de regi√µes para garantir espa√ßo para o Total
                regions.slice(0, maxRegionsToShow).forEach(r => {
                    doc.text(`${r.substring(0, cardWidth/2.5)}: ${sum[cat][r]}`, cardX + 2, y); 
                    y += 3.5; // Espa√ßamento entre linhas ligeiramente maior para evitar sobreposi√ß√£o
                });
                
                if (regions.length > maxRegionsToShow) {
                    doc.setFontSize(6);
                    doc.setTextColor(255, 0, 0);
                    doc.text(`... e mais ${regions.length - maxRegionsToShow}`, cardX + 2, y);
                }

                // Total (Posicionamento corrigido para o final do card)
                doc.setTextColor(0,0,0);
                doc.setFont(undefined, 'bold');
                doc.text(`Total: ${totalCat}`, cardX + 2, rowY + cardHeight - 3);
                doc.setFont(undefined, 'normal');

                col++;
                if (col >= cardsPerRow) {
                    col = 0;
                    rowY += cardHeight + cardGap;
                }
            }
        });

        // Retorna a posi√ß√£o final para o pr√≥ximo bloco de conte√∫do
        return rowY + (col > 0 ? cardHeight + cardGap : cardGap);
    }
    
    // Adiciona Totais Gerais e Tabelas de Concentra√ß√£o
    function addConcentrationTables(doc, startY){
        const pageHeight = doc.internal.pageSize.height;
        const pageBottomMargin = 15;

        // 1. Calcular Totais e Agrupamentos
        const totalEquipamentos = filteredData.length;
        const totalUnidades = new Set(filteredData.map(i => i.unidade)).size;
        const totalClientes = new Set(filteredData.map(i => i.cliente)).size;
        
        const regioes = {};
        const unidades = {};
        filteredData.forEach(i => {
            const regiao = i.regiao || 'Sem Regi√£o';
            const unidade = i.unidade || 'Sem Unidade';

            if (!regioes[regiao]) regioes[regiao] = { equipamentos: 0, clientes: new Set(), unidades: new Set() };
            regioes[regiao].equipamentos++;
            regioes[regiao].clientes.add(i.cliente);
            regioes[regiao].unidades.add(i.unidade);

            unidades[unidade] = (unidades[unidade] || 0) + 1;
        });
        
        // 2. Totais gerais
        if (startY > pageHeight - pageBottomMargin - 50) {
            doc.addPage();
            startY = 18;
        }

        doc.setFontSize(10);
        doc.setTextColor(44, 62, 80);
        doc.setFont(undefined, 'bold');
        doc.text(`Total de Equipamentos: ${totalEquipamentos}`, 14, startY);
        startY += 4;
        doc.text(`Total de Unidades: ${totalUnidades}`, 14, startY);
        startY += 4;
        doc.text(`Total de Clientes: ${totalClientes}`, 14, startY);
        doc.setFont(undefined, 'normal');
        startY += 8;

        // 3. Tabela de concentra√ß√£o por regi√£o
        if (startY > pageHeight - pageBottomMargin - 80) {
             doc.addPage();
             startY = 18;
        }

        doc.setFontSize(11);
        doc.setTextColor(41,128,185);
        doc.setFont(undefined, 'bold');
        doc.text('Concentra√ß√£o por Regi√£o:', 14, startY);
        doc.setFont(undefined, 'normal');
        startY += 5;
        
        const regiaoRows = Object.keys(regioes).sort().map(regiao => [
            regiao,
            regioes[regiao].equipamentos,
            `${((regioes[regiao].equipamentos / totalEquipamentos) * 100).toFixed(1)}%`,
            regioes[regiao].clientes.size,
            regioes[regiao].unidades.size
        ]);
        
        const totalEquipRegioes = Object.values(regioes).reduce((sum, r) => sum + r.equipamentos, 0);
        const totalClientesRegioes = new Set(filteredData.map(i => i.cliente)).size;
        const totalUnidadesRegioes = new Set(filteredData.map(i => i.unidade)).size;
        regiaoRows.push([ 'TOTAL', totalEquipRegioes, '100%', totalClientesRegioes, totalUnidadesRegioes ]);

        doc.autoTable({
            head: [['Regi√£o', 'Equipamentos', '%', 'Clientes', 'Unidades']],
            body: regiaoRows,
            startY: startY,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [41,128,185], textColor: 255, fontStyle: 'bold', fontSize: 8 },
            alternateRowStyles: { fillColor: [245,245,245] },
            margin: { left: 14, right: 14, bottom: pageBottomMargin },
            pageBreak: 'auto',
            rowPageBreak: 'avoid',
            showHead: 'everyPage',
            didParseCell: (data) => { // Destaque para a linha de Total
                if (data.row.index === regiaoRows.length - 1) {
                    data.cell.styles.fillColor = [44, 62, 80];
                    data.cell.styles.textColor = [255, 255, 255];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        });

        startY = doc.lastAutoTable.finalY + 8;
        
        // 4. Tabela das 10 unidades com mais equipamentos
        if (startY > pageHeight - pageBottomMargin - 80) {
             doc.addPage();
             startY = 18;
        }

        doc.setFontSize(11);
        doc.setTextColor(41,128,185);
        doc.setFont(undefined, 'bold');
        doc.text('Top 10 Unidades com Maior Concentra√ß√£o:', 14, startY);
        doc.setFont(undefined, 'normal');
        startY += 5;
        
        const unidadesOrdenadas = Object.keys(unidades)
            .sort((a, b) => unidades[b] - unidades[a])
            .slice(0, 10);
        
        const unidadeRows = unidadesOrdenadas.map(unidade => [
            unidade,
            unidades[unidade],
            `${((unidades[unidade] / totalEquipamentos) * 100).toFixed(1)}%`
        ]);

        doc.autoTable({
            head: [['Unidade', 'Quantidade', 'Percentual']],
            body: unidadeRows,
            startY: startY,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [41,128,185], textColor: 255, fontStyle: 'bold', fontSize: 8 },
            alternateRowStyles: { fillColor: [245,245,245] },
            margin: { left: 14, right: 14, bottom: pageBottomMargin },
            pageBreak: 'auto',
            rowPageBreak: 'avoid',
            showHead: 'everyPage'
        });

        startY = doc.lastAutoTable.finalY + 10;
        return startY;
    }

    // Adiciona Tabela Principal de Dados (Agrupada ou N√£o)
    function addMainDataTable(doc, startY) {
        const pageHeight = doc.internal.pageSize.height;
        const pageBottomMargin = 15;
        const fields = Array.from(selectedFields);
        // Ajuste no cabe√ßalho para caber melhor em paisagem
        const headers = fields.map(f => fieldLabels[f].length > 18 ? fieldLabels[f].substring(0,16) + '...' : fieldLabels[f]);

        // T√≠tulo da Tabela Principal
        if (startY > pageHeight - pageBottomMargin - 30) {
             doc.addPage();
             startY = 18;
        }

        doc.setFontSize(11);
        doc.setTextColor(41,128,185);
        doc.setFont(undefined, 'bold');
        doc.text('Detalhes dos Equipamentos:', 14, startY);
        doc.setFont(undefined, 'normal');
        startY += 5;


        if (selectedItems.size > 0 && ['cliente', 'unidade'].includes(currentSearchType)) {
            // Agrupar e gerar tabelas separadas para cada grupo
            const groupedData = groupByPdf(filteredData, currentSearchType);

            Object.keys(groupedData).sort().forEach(groupKey => {
                const groupItems = groupedData[groupKey];
                
                if (startY > pageHeight - pageBottomMargin - 25) {
                    doc.addPage();
                    startY = 18;
                }

                doc.setFontSize(10);
                doc.setTextColor(41,128,185);
                doc.setFont(undefined, 'bold');
                doc.text(`${fieldLabels[currentSearchType]}: ${groupKey}`, 14, startY);
                doc.setFont(undefined, 'normal');
                startY += 6;

                const rows = groupItems.map(i => fields.map(f => {
                    const val = i[f] || '';
                    return String(val).length > 50 ? String(val).substring(0,47) + '...' : val;
                }));

                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: startY,
                    theme: 'grid',
                    styles: { fontSize: 6.5, cellPadding: 1.5, overflow: 'linebreak', valign: 'middle' },
                    headStyles: { fillColor: [41,128,185], textColor: [255,255,255], fontStyle: 'bold', fontSize: 7 },
                    margin: { top: 15, left: 14, right: 14, bottom: pageBottomMargin },
                    pageBreak: 'auto',
                    rowPageBreak: 'avoid',
                    showHead: 'everyPage',
                    tableLineColor: [200,200,200],
                    tableLineWidth: 0.1
                });
                startY = doc.lastAutoTable.finalY + 10;
            });
        } else {
            // Tabela √∫nica para todos os dados
            if (startY > pageHeight - pageBottomMargin - 25) {
                doc.addPage();
                startY = 18;
            }

            const rows = filteredData.map(i => fields.map(f => {
                const val = i[f] || '';
                return String(val).length > 50 ? String(val).substring(0,47) + '...' : val;
            }));

            doc.autoTable({
                head: [headers],
                body: rows,
                startY: startY,
                theme: 'grid',
                styles: { fontSize: 6.5, cellPadding: 1.5, overflow: 'linebreak', valign: 'middle' },
                headStyles: { fillColor: [41,128,185], textColor: [255,255,255], fontStyle: 'bold', fontSize: 7 },
                margin: { top: 15, left: 14, right: 14, bottom: pageBottomMargin },
                pageBreak: 'auto',
                rowPageBreak: 'avoid',
                showHead: 'everyPage',
                tableLineColor: [200,200,200],
                tableLineWidth: 0.1
            });
            startY = doc.lastAutoTable.finalY + 10;
        }

        return startY;
    }

    /* ---------- FUN√á√ïES PRINCIPAIS DE GERA√á√ÉO DE PDF ---------- */

    // Visualizar/Imprimir PDF (Relat√≥rio Principal)
    function generatePDF(){
        if (filteredData.length === 0) {
            alert('Nenhum dado filtrado para gerar o PDF.');
            return;
        }

        const doc = new jsPDF('landscape', 'mm', 'a4');
        const title = "Relat√≥rio Principal de Patrim√¥nio";
        let startY = 10;
        
        // 1. Configura Cabe√ßalho/Rodap√©
        addHeaderFooter(doc, title);
        startY = 25; // Define o ponto de in√≠cio ap√≥s o cabe√ßalho inicial

        // 2. Adiciona Resumo dos Filtros Aplicados (TEXTO)
        startY = addFilterSummary(doc, startY);

        // 3. Adiciona Resumo por Categoria e Regi√£o (CARDS)
        startY = addRegiaoCategoriaSummaryCards(doc, startY);

        // 4. Adiciona Totais e Tabelas de Concentra√ß√£o
        startY = addConcentrationTables(doc, startY);

        // 5. Adiciona Tabela Principal de Dados (Agrupada ou N√£o)
        addMainDataTable(doc, startY);

        return doc;
    }

    function previewPDF() {
        try {
            const doc = generatePDF();
            const pdfBlob = doc.output('blob');
            openPDFPreview(pdfBlob);
        } catch (error) {
            console.error("Erro ao gerar PDF:", error);
            alert("Ocorreu um erro ao gerar o PDF. Verifique o console para mais detalhes.");
        }
    }

    // Gerar PDF de Resumo (Concentra√ß√£o e Agrupamento) - CORRIGIDO PARA LANDSCAPE
    function previewFilterSummaryPDF(){
        if (filteredData.length === 0) {
            alert('Nenhum dado filtrado para gerar o PDF de resumo.');
            return;
        }

        // CORRE√á√ÉO: Orienta√ß√£o do PDF alterada para 'landscape' (horizontal)
        const doc = new jsPDF('landscape', 'mm', 'a4');
        const title = "Resumo dos Filtros Aplicados";
        let startY = 10;

        addHeaderFooter(doc, title);
        startY = 25;

        // 1. Resumo dos Filtros Aplicados (TEXTO)
        startY = addFilterSummary(doc, startY);

        // 2. Resumo por Categoria e Regi√£o (CARDS) -> CORRE√á√ÉO APLICADA AQUI
        startY = addRegiaoCategoriaSummaryCards(doc, startY);

        // 3. Totais e Tabelas de Concentra√ß√£o
        startY = addConcentrationTables(doc, startY);
        
        // 4. Resumo por Equipamento
        const pageHeight = doc.internal.pageSize.height;
        const pageBottomMargin = 15;
        if (startY > pageHeight - pageBottomMargin - 30) {
             doc.addPage();
             startY = 18;
        }

        doc.setFontSize(11);
        doc.setTextColor(41,128,185);
        doc.setFont(undefined, 'bold');
        doc.text('Equipamentos Encontrados:', 14, startY);
        doc.setFont(undefined, 'normal');
        startY += 5;

        const equipCount = {};
        filteredData.forEach(i => { equipCount[i.equipamento || 'Sem Equipamento'] = (equipCount[i.equipamento || 'Sem Equipamento'] || 0) + 1; });
        
        const equipRows = Object.keys(equipCount).sort().map(k => [ 
            k.length > 50 ? k.substring(0,48) + '...' : k, 
            equipCount[k] 
        ]);

        doc.autoTable({
            head: [['Equipamento', 'Quantidade']],
            body: equipRows,
            startY: startY,
            theme: 'grid',
            styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [41,128,185], textColor: 255, fontStyle: 'bold', fontSize: 7.5 },
            alternateRowStyles: { fillColor: [245,245,245] },
            margin: { left: 14, right: 14, bottom: pageBottomMargin },
            pageBreak: 'auto',
            rowPageBreak: 'avoid',
            showHead: 'everyPage'
        });

        const pdfBlob = doc.output('blob');
        openPDFPreview(pdfBlob);
    }
    
    // Gerar PDF de Resumo Detalhado por Cliente (Tabela Din√¢mica)
    function generateDetailedSummaryPDF(){
        if (filteredData.length === 0) {
            alert('Nenhum dado filtrado para gerar o PDF de resumo detalhado.');
            return;
        }
        
        const doc = new jsPDF('landscape', 'mm', 'a4');
        const title = "Resumo Detalhado por Cliente";
        let startY = 10;
        const pageBottomMargin = 15;

        addHeaderFooter(doc, title);
        startY = 25;

        // 1. Calcular resumo detalhado
        const clientSummary = {};
        const allCategories = new Set();
        filteredData.forEach(i => {
            const client = i.cliente || 'Sem Cliente';
            const category = i.categoria || 'Sem Categoria';
            if (!clientSummary[client]) {
                clientSummary[client] = { unidades: new Set(), categorias: {}, totalEquipamentos: 0 };
            }
            clientSummary[client].unidades.add(i.unidade);
            clientSummary[client].categorias[category] = (clientSummary[client].categorias[category] || 0) + 1;
            clientSummary[client].totalEquipamentos++;
            allCategories.add(category);
        });

        // 2. Preparar dados para a tabela
        const sortedCategories = Array.from(allCategories).sort();
        const clientHeaders = [['Cliente', 'Unid.', 'Total', ...sortedCategories.map(c => c.length > 15 ? c.substring(0,13) + '...' : c)]];
        
        const clientRows = Object.keys(clientSummary).sort().map(k => [
            k.length > 30 ? k.substring(0,28) + '...' : k,
            clientSummary[k].unidades.size,
            clientSummary[k].totalEquipamentos,
            ...sortedCategories.map(cat => clientSummary[k].categorias[cat] || 0)
        ]);

        const clientTotalRow = ['TOTAL', new Set(filteredData.map(i => i.unidade)).size, filteredData.length, ...sortedCategories.map(cat => filteredData.filter(i => i.categoria === cat).length)];
        clientRows.push(clientTotalRow);

        // 3. Gerar tabela
        doc.autoTable({
            head: clientHeaders,
            body: clientRows,
            startY: startY,
            theme: 'grid',
            styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
            headStyles: { fillColor: [41,128,185], textColor: 255, fontStyle: 'bold', fontSize: 7.5 },
            alternateRowStyles: { fillColor: [245,245,245] },
            margin: { left: 14, right: 14, bottom: pageBottomMargin },
            pageBreak: 'auto',
            rowPageBreak: 'avoid',
            showHead: 'everyPage',
            didParseCell: (data) => {
                if (data.row.index === clientRows.length - 1) { // Linha de Total
                    data.cell.styles.fillColor = [44, 62, 80];
                    data.cell.styles.textColor = [255, 255, 255];
                    data.cell.styles.fontStyle = 'bold';
                }
            }
        });
        
        const pdfBlob = doc.output('blob');
        openPDFPreview(pdfBlob);
    }
    
    /* ---------- NOVO MODAL RESUMO DETALHADO (Interface) ---------- */ 
    function showDetailedSummaryModal(){
        // O JS para preenchimento j√° existe na fun√ß√£o updateFilterSummary,
        // mas vamos replicar a l√≥gica aqui para o modal dedicado, garantindo que a tabela seja montada
        // com o mesmo formato, mas sem as limita√ß√µes de espa√ßo do card de resumo.

        const clientSummary = {};
        const allCategories = new Set();
        filteredData.forEach(i => {
            const client = i.cliente || 'Sem Cliente';
            const category = i.categoria || 'Sem Categoria';
            if (!clientSummary[client]) {
                clientSummary[client] = { unidades: new Set(), categorias: {}, totalEquipamentos: 0 };
            }
            clientSummary[client].unidades.add(i.unidade);
            clientSummary[client].categorias[category] = (clientSummary[client].categorias[category] || 0) + 1;
            clientSummary[client].totalEquipamentos++;
            allCategories.add(category);
        });

        // Preencher tabela no modal
        const header = document.getElementById('detailed-summary-header');
        const body = document.getElementById('detailed-summary-body');
        header.innerHTML = '';
        
        let headerRow = document.createElement('tr');
        headerRow.innerHTML = '<th>Cliente</th><th>Unidades</th><th>Total</th>';
        Array.from(allCategories).sort().forEach(cat => { headerRow.innerHTML += `<th>${cat}</th>`; });
        header.appendChild(headerRow);
        
        body.innerHTML = '';
        Object.keys(clientSummary).sort().forEach(client => {
            const row = document.createElement('tr');
            let rowHTML = `<td>${client}</td><td>${clientSummary[client].unidades.size}</td><td class="category-column"><strong>${clientSummary[client].totalEquipamentos}</strong></td>`;
            Array.from(allCategories).sort().forEach(cat => {
                const count = clientSummary[client].categorias[cat] || 0;
                rowHTML += `<td class="category-column">${count > 0 ? count : '-'}</td>`;
            });
            row.innerHTML = rowHTML;
            body.appendChild(row);
        });

        // Adicionar linha de total
        const totalRow = document.createElement('tr');
        totalRow.className = 'total-row';
        let totalHTML = `<td><strong>TOTAL</strong></td><td><strong>${new Set(filteredData.map(i => i.unidade)).size}</strong></td><td class="category-column"><strong>${filteredData.length}</strong></td>`;
        Array.from(allCategories).sort().forEach(cat => {
            const count = filteredData.filter(i => i.categoria === cat).length;
            totalHTML += `<td class="category-column">${count}</td>`;
        });
        totalRow.innerHTML = totalHTML;
        body.appendChild(totalRow);

        new bootstrap.Modal(document.getElementById('detailed-summary-modal')).show();
    }
    
    function showCategorySummaryModal(){ 
        const grouped = groupBy(filteredData, 'categoria');
        const modalBody = Object.keys(grouped).sort().map(k=>{
            const items = grouped[k];
            const subGrouped = groupBy(items, 'regiao');
            const subGroupsHtml = Object.keys(subGrouped).sort().map(regiao => {
                const count = subGrouped[regiao].length;
                return `<div class="p-2 mb-1 bg-light rounded d-flex justify-content-between align-items-center" style="font-size:0.9rem;"><span>${regiao}</span><span class="badge bg-secondary">${count}</span></div>`;
            }).join('');
            
            return `
                <div class="mb-3">
                    <h6>${k} <span class="equipment-count">${items.length} Equipamentos</span></h6>
                    ${subGroupsHtml}
                </div>
            `;
        }).join('');
        
        const modal = new bootstrap.Modal(document.getElementById('category-summary-modal'));
        document.getElementById('category-summary-modal-body').innerHTML = modalBody;
        modal.show();
    }

    // Ocultar sugest√µes ao clicar fora
    document.addEventListener('click', (e) => {
        const searchContainer = document.querySelector('.search-container');
        if (searchContainer && !searchContainer.contains(e.target)) {
            hideSuggestions();
        }
    });

    // Inicia a lista de colunas selecionadas no carregamento
    document.addEventListener('DOMContentLoaded', () => {
        populateColumnCheckboxes();
    });
</script>
</body>
</html>